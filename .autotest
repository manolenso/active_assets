require 'autotest/restart'
require 'autotest/bundler'

Autotest.add_hook :initialize do |at|
  # We don't want the default mappings
  at.clear_mappings

  # Don't track other dirs, this just burns cpu.
  # (File.read('.gitignore').split("\n")).each do |ignore|
  #   at.add_exception ignore
  # end

  # Test::Unit is normally test_, so autotest doesn't have this mapping. Tests
  # want to match themselves, that is, if there's no changes, run them all.
  at.add_mapping(%r%^test.*/.*_test\.rb$%) { |f, _| p f }

  # Allow for matches of lib files to test files in a flat way
  at.add_mapping(%r%^lib/(?:.*/)?([^/]+)\.rb$%) do |f, md|
    at.files_matching %r%^test/lib/.*#{md[1]}_test\.rb$%
  end

  # Make sure that we run all tests if the helper changes:
  at.add_mapping(%r%^test/helper\.rb$%) do |f, _|
    at.files_matching %r%.*_test\.rb%
  end

  # If bundle did something, run all tests again
  at.add_mapping(%r%^Gemfile\.lock$%) do |f, _|
    at.files_matching %r%.*_test\.rb%
  end
end
